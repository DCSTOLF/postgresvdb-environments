environment: prod

vdb:
  name: "prod-vdb"
  database:
    name: "prod_application"
    user: "prod_user"
    password: "CHANGE_ME_PROD_PASSWORD"  # Should be replaced with secret reference
  
  resources:
    requests:
      memory: "4Gi"
      cpu: "2"
    limits:
      memory: "8Gi"
      cpu: "4"
  
  # Production-grade PostgreSQL configuration
  postgresConfig:
    - name: "shared_buffers"
      value: "1GB"
    - name: "max_connections"
      value: "300"
    - name: "effective_cache_size"
      value: "3GB"
    - name: "maintenance_work_mem"
      value: "512MB"
    - name: "checkpoint_completion_target"
      value: "0.9"
    - name: "wal_buffers"
      value: "32MB"
    - name: "default_statistics_target"
      value: "100"
    - name: "random_page_cost"
      value: "1.1"
    - name: "effective_io_concurrency"
      value: "200"
    - name: "work_mem"
      value: "40MB"
    - name: "min_wal_size"
      value: "2GB"
    - name: "max_wal_size"
      value: "8GB"
    - name: "max_worker_processes"
      value: "8"
    - name: "max_parallel_workers_per_gather"
      value: "4"
    - name: "max_parallel_workers"
      value: "8"
    - name: "max_parallel_maintenance_workers"
      value: "4"
    # Logging configuration
    - name: "log_min_duration_statement"
      value: "500"
    - name: "log_connections"
      value: "on"
    - name: "log_disconnections"
      value: "on"
    - name: "log_line_prefix"
      value: "%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h "
    - name: "log_checkpoints"
      value: "on"
    - name: "log_lock_waits"
      value: "on"
    - name: "log_temp_files"
      value: "0"
    # Performance and reliability
    - name: "track_activities"
      value: "on"
    - name: "track_counts"
      value: "on"
    - name: "track_io_timing"
      value: "on"
    - name: "track_functions"
      value: "all"
  
  hooks:
    - name: "init-prod-schema"
      stage: "post-create"
      database: "prod_application"
      script: |
        -- Create production schemas
        CREATE SCHEMA IF NOT EXISTS prod_data;
        CREATE SCHEMA IF NOT EXISTS prod_audit;
        
        -- Create audit log table
        CREATE TABLE IF NOT EXISTS prod_audit.audit_log (
          audit_id BIGSERIAL PRIMARY KEY,
          table_name VARCHAR(100) NOT NULL,
          operation VARCHAR(10) NOT NULL,
          user_name VARCHAR(100) NOT NULL,
          timestamp TIMESTAMP DEFAULT NOW(),
          old_data JSONB,
          new_data JSONB
        );
        
        -- Create indexes for audit log
        CREATE INDEX IF NOT EXISTS idx_audit_log_table ON prod_audit.audit_log(table_name);
        CREATE INDEX IF NOT EXISTS idx_audit_log_timestamp ON prod_audit.audit_log(timestamp DESC);
        CREATE INDEX IF NOT EXISTS idx_audit_log_user ON prod_audit.audit_log(user_name);
        
        -- Create health check table
        CREATE TABLE IF NOT EXISTS prod_audit.health_checks (
          check_id SERIAL PRIMARY KEY,
          check_name VARCHAR(100) NOT NULL,
          status VARCHAR(20) NOT NULL,
          response_time_ms INTEGER,
          checked_at TIMESTAMP DEFAULT NOW(),
          message TEXT
        );
        
        -- Grant permissions
        GRANT USAGE ON SCHEMA prod_data TO prod_user;
        GRANT USAGE ON SCHEMA prod_audit TO prod_user;
        GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA prod_data TO prod_user;
        GRANT INSERT, SELECT ON ALL TABLES IN SCHEMA prod_audit TO prod_user;
        GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA prod_data TO prod_user;
        GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA prod_audit TO prod_user;
        
        -- Create readonly role for production
        DO $$
        BEGIN
          IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'prod_readonly') THEN
            CREATE ROLE prod_readonly;
          END IF;
        END
        $$;
        
        GRANT CONNECT ON DATABASE prod_application TO prod_readonly;
        GRANT USAGE ON SCHEMA prod_data TO prod_readonly;
        GRANT SELECT ON ALL TABLES IN SCHEMA prod_data TO prod_readonly;
        ALTER DEFAULT PRIVILEGES IN SCHEMA prod_data GRANT SELECT ON TABLES TO prod_readonly;
        
        -- Log initialization
        INSERT INTO prod_audit.health_checks (check_name, status, response_time_ms, message) 
        VALUES ('database_initialization', 'SUCCESS', 0, 'Production database initialized successfully');

# Monitoring enabled for production
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: "15s"
    scrapeTimeout: "10s"

# Service configuration
service:
  type: ClusterIP
  annotations:
    prod.environment: "true"
    prod.criticality: "high"

# Security context
securityContext:
  runAsUser: 999
  runAsGroup: 999
  fsGroup: 999
  runAsNonRoot: true

# Pod annotations for production
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9187"
