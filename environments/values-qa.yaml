environment: qa

vdb:
  name: "qa-vdb"
  database:
    name: "postgres"
    user: "postgres"
    password: "Delphix_123!"
  resources:
    requests:
      memory: "2Gi"
      cpu: "1"
    limits:
      memory: "4Gi"
      cpu: "2"
  
  hooks:
    - name: "init-qa-schema"
      stage: "post-create"
      database: "sampledb"
      script: |
        -- Create QA schemas
        CREATE SCHEMA IF NOT EXISTS qa_testing;
        CREATE SCHEMA IF NOT EXISTS qa_results;
        
        -- Create test results table
        CREATE TABLE IF NOT EXISTS qa_testing.test_results (
          test_id SERIAL PRIMARY KEY,
          test_suite VARCHAR(100) NOT NULL,
          test_name VARCHAR(255) NOT NULL,
          result BOOLEAN NOT NULL,
          error_message TEXT,
          executed_at TIMESTAMP DEFAULT NOW(),
          executed_by VARCHAR(100),
          duration_seconds DECIMAL(10,3)
        );
        
        -- Create test metrics table
        CREATE TABLE IF NOT EXISTS qa_results.test_metrics (
          metric_id SERIAL PRIMARY KEY,
          metric_name VARCHAR(100) NOT NULL,
          metric_value DECIMAL(15,4) NOT NULL,
          metric_unit VARCHAR(50),
          recorded_at TIMESTAMP DEFAULT NOW(),
          test_id INTEGER REFERENCES qa_testing.test_results(test_id)
        );
        
        -- Create indexes for performance
        CREATE INDEX IF NOT EXISTS idx_test_results_suite ON qa_testing.test_results(test_suite);
        CREATE INDEX IF NOT EXISTS idx_test_results_executed_at ON qa_testing.test_results(executed_at DESC);
        CREATE INDEX IF NOT EXISTS idx_test_metrics_test_id ON qa_results.test_metrics(test_id);
        
        -- Grant permissions
        GRANT USAGE ON SCHEMA qa_testing TO qa_user;
        GRANT USAGE ON SCHEMA qa_results TO qa_user;
        GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA qa_testing TO qa_user;
        GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA qa_results TO qa_user;
        GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA qa_testing TO qa_user;
        GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA qa_results TO qa_user;
        
        -- Create view for test summary
        CREATE OR REPLACE VIEW qa_results.test_summary AS
        SELECT 
          test_suite,
          COUNT(*) as total_tests,
          SUM(CASE WHEN result = true THEN 1 ELSE 0 END) as passed_tests,
          SUM(CASE WHEN result = false THEN 1 ELSE 0 END) as failed_tests,
          AVG(duration_seconds) as avg_duration,
          MAX(executed_at) as last_run
        FROM qa_testing.test_results
        GROUP BY test_suite;
        
        GRANT SELECT ON qa_results.test_summary TO qa_user;
        
        -- Log initialization
        INSERT INTO qa_testing.test_results (test_suite, test_name, result, executed_by) 
        VALUES ('infrastructure', 'qa_schema_initialization', true, 'system');

# Monitoring enabled for QA
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: "30s"

# Service configuration
service:
  type: ClusterIP
  annotations:
    qa.environment: "true"
