environment: feature
featureBranch: "feat-456"

vdb:
  name: "feat-456-vdb"
  database:
    name: "feat_456_app"
    user: "feat_456_user"
    password: "feat_456_password"
  
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1"
  
  hooks:
    - name: "init-feat-456-schema"
      stage: "post-create"
      database: "feat_456_app"
      script: |
        -- Create feature-specific schemas
        CREATE SCHEMA IF NOT EXISTS feat_456_development;
        CREATE SCHEMA IF NOT EXISTS feat_456_analytics;
        
        -- Create development tables
        CREATE TABLE IF NOT EXISTS feat_456_development.feature_work (
          id SERIAL PRIMARY KEY,
          work_item VARCHAR(255) NOT NULL,
          work_type VARCHAR(50) NOT NULL,
          status VARCHAR(50) DEFAULT 'in_progress',
          priority INTEGER DEFAULT 5,
          data JSONB,
          created_at TIMESTAMP DEFAULT NOW(),
          updated_at TIMESTAMP DEFAULT NOW()
        );
        
        -- Create analytics table for performance testing
        CREATE TABLE IF NOT EXISTS feat_456_analytics.performance_metrics (
          metric_id SERIAL PRIMARY KEY,
          operation_name VARCHAR(100) NOT NULL,
          execution_time_ms INTEGER NOT NULL,
          memory_used_mb DECIMAL(10,2),
          cpu_usage_percent DECIMAL(5,2),
          timestamp TIMESTAMP DEFAULT NOW(),
          metadata JSONB
        );
        
        -- Create comparison table to track before/after metrics
        CREATE TABLE IF NOT EXISTS feat_456_analytics.comparison_results (
          comparison_id SERIAL PRIMARY KEY,
          test_name VARCHAR(255) NOT NULL,
          baseline_value DECIMAL(15,4),
          current_value DECIMAL(15,4),
          improvement_percent DECIMAL(7,2),
          passed_threshold BOOLEAN,
          recorded_at TIMESTAMP DEFAULT NOW()
        );
        
        -- Create indexes
        CREATE INDEX IF NOT EXISTS idx_feature_work_status ON feat_456_development.feature_work(status);
        CREATE INDEX IF NOT EXISTS idx_performance_metrics_operation ON feat_456_analytics.performance_metrics(operation_name);
        CREATE INDEX IF NOT EXISTS idx_performance_metrics_timestamp ON feat_456_analytics.performance_metrics(timestamp DESC);
        
        -- Grant permissions
        GRANT ALL ON SCHEMA feat_456_development TO feat_456_user;
        GRANT ALL ON SCHEMA feat_456_analytics TO feat_456_user;
        GRANT ALL ON ALL TABLES IN SCHEMA feat_456_development TO feat_456_user;
        GRANT ALL ON ALL TABLES IN SCHEMA feat_456_analytics TO feat_456_user;
        GRANT ALL ON ALL SEQUENCES IN SCHEMA feat_456_development TO feat_456_user;
        GRANT ALL ON ALL SEQUENCES IN SCHEMA feat_456_analytics TO feat_456_user;
        
        -- Create materialized view for analytics summary
        CREATE MATERIALIZED VIEW feat_456_analytics.performance_summary AS
        SELECT 
          operation_name,
          COUNT(*) as execution_count,
          AVG(execution_time_ms) as avg_execution_time,
          MIN(execution_time_ms) as min_execution_time,
          MAX(execution_time_ms) as max_execution_time,
          PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY execution_time_ms) as p95_execution_time,
          AVG(memory_used_mb) as avg_memory_used,
          AVG(cpu_usage_percent) as avg_cpu_usage
        FROM feat_456_analytics.performance_metrics
        GROUP BY operation_name;
        
        GRANT SELECT ON feat_456_analytics.performance_summary TO feat_456_user;
        
        -- Insert initial work items
        INSERT INTO feat_456_development.feature_work (work_item, work_type, priority)
        VALUES 
          ('Implement new feature logic', 'development', 1),
          ('Write unit tests', 'testing', 2),
          ('Performance optimization', 'optimization', 3);

# Monitoring for feature branch
monitoring:
  enabled: true
  serviceMonitor:
    enabled: false

# Service configuration
service:
  type: ClusterIP
  annotations:
    feature.branch: "feat-456"
    feature.expires: "30d"
    feature.owner: "performance-team"
