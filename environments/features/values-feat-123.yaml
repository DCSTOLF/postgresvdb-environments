environment: feature
featureBranch: "feat-123"

vdb:
  name: "feat-123-vdb"
  database:
    name: "feat_123_app"
    user: "feat_123_user"
    password: "feat_123_password"
  
  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "2Gi"
      cpu: "1"
  
  # PostgreSQL configuration optimized for feature branch (1Gi memory, 0.5 CPU)
  postgresConfig:
    - name: "listen_addresses"
      value: "*"
    - name: "max_connections"
      value: "15"
    - name: "shared_buffers"
      value: "256MB"
    - name: "effective_cache_size"
      value: "768MB"
    - name: "work_mem"
      value: "4MB"
    - name: "maintenance_work_mem"
      value: "64MB"
    - name: "temp_buffers"
      value: "4MB"
    - name: "dynamic_shared_memory_type"
      value: "posix"
    - name: "bgwriter_delay"
      value: "500ms"
    - name: "bgwriter_lru_maxpages"
      value: "100"
    - name: "bgwriter_lru_multiplier"
      value: "2.0"
    - name: "bgwriter_flush_after"
      value: "256kB"
    - name: "max_worker_processes"
      value: "2"
    - name: "max_parallel_workers_per_gather"
      value: "0"
    - name: "max_parallel_maintenance_workers"
      value: "0"
    - name: "max_parallel_workers"
      value: "1"
    - name: "wal_level"
      value: "minimal"
    - name: "wal_sync_method"
      value: "open_datasync"
    - name: "full_page_writes"
      value: "on"
    - name: "wal_compression"
      value: "lz4"
    - name: "wal_buffers"
      value: "4MB"
    - name: "wal_writer_delay"
      value: "10ms"
    - name: "wal_writer_flush_after"
      value: "256kB"
    - name: "commit_siblings"
      value: "3"
    - name: "checkpoint_timeout"
      value: "30min"
    - name: "checkpoint_completion_target"
      value: "0.9"
    - name: "max_wal_size"
      value: "1GB"
    - name: "min_wal_size"
      value: "256MB"
    - name: "max_wal_senders"
      value: "0"
    - name: "log_min_duration_statement"
      value: "5000"
    - name: "log_checkpoints"
      value: "on"
    - name: "autovacuum"
      value: "on"
    - name: "autovacuum_max_workers"
      value: "1"
    - name: "autovacuum_vacuum_scale_factor"
      value: "0.2"
    - name: "autovacuum_analyze_scale_factor"
      value: "0.1"
    - name: "autovacuum_vacuum_cost_delay"
      value: "20ms"
    - name: "autovacuum_vacuum_cost_limit"
      value: "500"
    - name: "max_locks_per_transaction"
      value: "64"
    - name: "idle_in_transaction_session_timeout"
      value: "10min"
    - name: "statement_timeout"
      value: "30s"
    - name: "lock_timeout"
      value: "10s"
  
  hooks:
    - name: "init-feat-schema"
      stage: "post-create"
      database: "feat_123_app"
      script: |
        -- Create feature-specific schemas
        CREATE SCHEMA IF NOT EXISTS feat_123_experimental;
        CREATE SCHEMA IF NOT EXISTS feat_123_testing;
        
        -- Create experimental data table
        CREATE TABLE IF NOT EXISTS feat_123_experimental.experimental_data (
          id SERIAL PRIMARY KEY,
          feature_name VARCHAR(100) NOT NULL,
          feature_data JSONB,
          created_at TIMESTAMP DEFAULT NOW(),
          updated_at TIMESTAMP DEFAULT NOW(),
          created_by VARCHAR(100),
          status VARCHAR(50) DEFAULT 'active'
        );
        
        -- Create feature flag table
        CREATE TABLE IF NOT EXISTS feat_123_experimental.feature_flags (
          flag_id SERIAL PRIMARY KEY,
          flag_name VARCHAR(100) UNIQUE NOT NULL,
          enabled BOOLEAN DEFAULT false,
          description TEXT,
          created_at TIMESTAMP DEFAULT NOW()
        );
        
        -- Create test data table
        CREATE TABLE IF NOT EXISTS feat_123_testing.test_data (
          test_id SERIAL PRIMARY KEY,
          test_case VARCHAR(255) NOT NULL,
          input_data JSONB,
          expected_output JSONB,
          actual_output JSONB,
          passed BOOLEAN,
          executed_at TIMESTAMP DEFAULT NOW()
        );
        
        -- Create indexes
        CREATE INDEX IF NOT EXISTS idx_experimental_data_feature ON feat_123_experimental.experimental_data(feature_name);
        CREATE INDEX IF NOT EXISTS idx_experimental_data_status ON feat_123_experimental.experimental_data(status);
        CREATE INDEX IF NOT EXISTS idx_test_data_case ON feat_123_testing.test_data(test_case);
        
        -- Grant permissions
        GRANT ALL ON SCHEMA feat_123_experimental TO feat_123_user;
        GRANT ALL ON SCHEMA feat_123_testing TO feat_123_user;
        GRANT ALL ON ALL TABLES IN SCHEMA feat_123_experimental TO feat_123_user;
        GRANT ALL ON ALL TABLES IN SCHEMA feat_123_testing TO feat_123_user;
        GRANT ALL ON ALL SEQUENCES IN SCHEMA feat_123_experimental TO feat_123_user;
        GRANT ALL ON ALL SEQUENCES IN SCHEMA feat_123_testing TO feat_123_user;
        
        -- Insert initial feature flags
        INSERT INTO feat_123_experimental.feature_flags (flag_name, enabled, description)
        VALUES 
          ('feat_123_enabled', true, 'Master feature flag for feat-123'),
          ('feat_123_debug_mode', false, 'Enable debug logging for feat-123')
        ON CONFLICT (flag_name) DO NOTHING;
        
        -- Insert sample data
        INSERT INTO feat_123_experimental.experimental_data (feature_name, feature_data, created_by)
        VALUES ('feat-123-init', '{"status": "initialized", "version": "0.1.0"}'::jsonb, 'system');

# Monitoring for feature branch
monitoring:
  enabled: true
  serviceMonitor:
    enabled: false

# Service configuration
service:
  type: ClusterIP
  annotations:
    feature.branch: "feat-123"
    feature.expires: "30d"
