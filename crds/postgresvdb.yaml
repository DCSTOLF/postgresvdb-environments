apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: postgresvdbs.core.delphix.com
  annotations:
    controller-gen.kubebuilder.io/version: v0.11.1
spec:
  group: core.delphix.com
  names:
    kind: PostgresVDB
    listKind: PostgresVDBList
    plural: postgresvdbs
    singular: postgresvdb
    shortNames:
    - pvdb
    - vdb
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        description: PostgresVDB is the Schema for the postgresvdbs API
        type: object
        properties:
          apiVersion:
            description: 'APIVersion defines the versioned schema of this representation of an object.'
            type: string
          kind:
            description: 'Kind is a string value representing the REST resource this object represents.'
            type: string
          metadata:
            type: object
          spec:
            description: PostgresVDBSpec defines the desired state of PostgresVDB
            type: object
            required:
            - source
            - port
            - image
            - database
            properties:
              source:
                description: Source configuration for the VDB
                type: object
                required:
                - type
                - reference
                properties:
                  type:
                    description: Source type (e.g., dct-source, snapshot, backup)
                    type: string
                    enum:
                    - dct-source
                    - snapshot
                    - backup
                  reference:
                    description: Reference to the source (e.g., "10.0.1.54:largedb")
                    type: string
                  snapshotId:
                    description: Snapshot ID if type is snapshot
                    type: string
              port:
                description: PostgreSQL port
                type: integer
                minimum: 1024
                maximum: 65535
                default: 5432
              image:
                description: PostgreSQL container image
                type: string
              mountPath:
                description: Path where data will be mounted
                type: string
                default: /mnt/postgres
              ownershipSpec:
                description: Ownership specification (UID:GID)
                type: string
                default: "999:999"
              mode:
                description: VDB mode (Primary, Standby)
                type: string
                enum:
                - Primary
                - Standby
                default: Primary
              errorBackoffPeriod:
                description: Error backoff period
                type: string
                default: 5m
              enabled:
                description: Enable or disable the VDB
                type: boolean
                default: true
              database:
                description: Database configuration
                type: object
                required:
                - name
                - user
                - password
                properties:
                  name:
                    description: Database name
                    type: string
                  user:
                    description: Database user
                    type: string
                  password:
                    description: Database password
                    type: string
              resources:
                description: Resource requirements
                type: object
                properties:
                  requests:
                    description: Resource requests
                    type: object
                    properties:
                      memory:
                        description: Memory request
                        type: string
                      cpu:
                        description: CPU request
                        type: string
                  limits:
                    description: Resource limits
                    type: object
                    properties:
                      memory:
                        description: Memory limit
                        type: string
                      cpu:
                        description: CPU limit
                        type: string
              postgresConfig:
                description: PostgreSQL configuration parameters
                type: array
                items:
                  type: object
                  required:
                  - name
                  - value
                  properties:
                    name:
                      description: Configuration parameter name
                      type: string
                    value:
                      description: Configuration parameter value
                      type: string
              hooks:
                description: Lifecycle hooks
                type: array
                items:
                  type: object
                  required:
                  - name
                  - stage
                  - script
                  properties:
                    name:
                      description: Hook name
                      type: string
                    stage:
                      description: Hook stage (pre-create, post-create, pre-delete, post-delete)
                      type: string
                      enum:
                      - pre-create
                      - post-create
                      - pre-delete
                      - post-delete
                      - pre-refresh
                      - post-refresh
                    type:
                      description: Hook type (sql, command)
                      type: string
                      enum:
                      - sql
                      - command
                      default: sql
                    script:
                      description: Hook script content
                      type: string
                    database:
                      description: Target database for the hook (defaults to main database)
                      type: string
                    weight:
                      description: Hook execution weight (for ordering)
                      type: integer
                      default: 5
                    backoffLimit:
                      description: Number of retries on failure
                      type: integer
                      default: 3
                    env:
                      description: Environment variables for the hook
                      type: object
                      additionalProperties:
                        type: string
              storageClass:
                description: Storage class for persistent volumes
                type: string
              storageSize:
                description: Storage size request
                type: string
                default: 10Gi
          status:
            description: PostgresVDBStatus defines the observed state of PostgresVDB
            type: object
            properties:
              phase:
                description: Current phase of the VDB
                type: string
                enum:
                - Pending
                - Provisioning
                - Running
                - Failed
                - Deleting
              conditions:
                description: Current conditions of the VDB
                type: array
                items:
                  type: object
                  required:
                  - type
                  - status
                  properties:
                    type:
                      description: Condition type
                      type: string
                    status:
                      description: Condition status
                      type: string
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                    reason:
                      description: Reason for the condition
                      type: string
                    message:
                      description: Human-readable message
                      type: string
                    lastTransitionTime:
                      description: Last time the condition transitioned
                      type: string
                      format: date-time
              connectionString:
                description: Connection string for the VDB
                type: string
              endpoint:
                description: Endpoint information
                type: object
                properties:
                  host:
                    type: string
                  port:
                    type: integer
              lastSyncTime:
                description: Last successful sync time
                type: string
                format: date-time
              observedGeneration:
                description: Last observed generation
                type: integer
                format: int64
    additionalPrinterColumns:
    - name: Phase
      type: string
      description: Current phase
      jsonPath: .status.phase
    - name: Source
      type: string
      description: Source reference
      jsonPath: .spec.source.reference
    - name: Port
      type: integer
      description: PostgreSQL port
      jsonPath: .spec.port
    - name: Database
      type: string
      description: Database name
      jsonPath: .spec.database.name
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
    subresources:
      status: {}
